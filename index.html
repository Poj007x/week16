<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏™‡∏±‡∏ï‡∏´‡∏µ‡∏ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-3xl mx-auto p-6">
        <h1 class="text-2xl font-bold mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>

        <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° -->
        <form id="activityForm" class="space-y-4 bg-white p-6 rounded-lg shadow">
            <div>
                <label class="block font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                <input type="text" id="activityName" required class="w-full border rounded px-3 py-2" />
            </div>
            <div>
                <label class="block font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                <input type="date" id="activityDate" required class="w-full border rounded px-3 py-2" />
            </div>
            <div>
                <label class="block font-medium mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
                <input type="text" id="responsible" required class="w-full border rounded px-3 py-2" />
            </div>
            <div>
                <label class="block font-medium mb-1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                <input type="text" id="targetGroup" required class="w-full border rounded px-3 py-2" />
            </div>
            <div>
                <label class="block font-medium mb-1">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
                <textarea id="objective" required class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div>
                <label class="block font-medium mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                <textarea id="details" required class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div>
                <label class="block font-medium mb-1">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
                <textarea id="results" required class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div>
                <label class="block font-medium mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏£‡∏π‡∏õ)</label>
                <input type="file" id="images" multiple accept="image/*" class="w-full" />
            </div>
            <div>
                <label class="block font-medium mb-1">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (PDF)</label>
                <input type="file" id="documents" multiple accept=".pdf" class="w-full" />
            </div>
            <button type="submit" id="submitBtn"
                class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° -->
        <div id="activities" class="mt-10 bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-4">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <div id="activityList" class="space-y-3 text-gray-700">
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ ‡πÉ‡∏™‡πà URL Apps Script Web App ‡∏ó‡∏µ‡πà deploy ‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXCOn4BHD1RcDBMFyIYNubV1H66aBh3bhZyb7oSHKOZpdviChCDlze7LpaSAT0uVZU/exec";

        // Helper: ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(",")[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Submit form
        document.getElementById("activityForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = document.getElementById("submitBtn");
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const formData = {
                    action: "saveActivity",
                    activityName: document.getElementById("activityName").value,
                    activityDate: document.getElementById("activityDate").value,
                    responsible: document.getElementById("responsible").value,
                    targetGroup: document.getElementById("targetGroup").value,
                    objective: document.getElementById("objective").value,
                    details: document.getElementById("details").value,
                    results: document.getElementById("results").value,
                    timestamp: new Date().toISOString(),
                    images: [],
                    documents: []
                };

                // Process images
                const imageFiles = document.getElementById("images").files;
                for (let i = 0; i < Math.min(imageFiles.length, 3); i++) {
                    const file = imageFiles[i];
                    const base64 = await fileToBase64(file);
                    formData.images.push({ name: file.name, type: file.type, data: base64 });
                }

                // Process documents
                const documentFiles = document.getElementById("documents").files;
                for (let file of documentFiles) {
                    const base64 = await fileToBase64(file);
                    formData.documents.push({ name: file.name, type: file.type, data: base64 });
                }

                // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();

                if (result.success) {
                    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    e.target.reset();
                    loadActivities();
                } else {
                    throw new Error(result.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                }
            } catch (err) {
                alert("‚ùå Error: " + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            }
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        async function loadActivities() {
            try {
                const response = await fetch(APPS_SCRIPT_URL + "?action=getActivities");
                const result = await response.json();
                const container = document.getElementById("activityList");

                if (result.success && result.data.length > 0) {
                    container.innerHTML = result.data.slice(-5).reverse().map(act => `
                        <div class="border rounded p-3">
                            <h3 class="font-semibold">${act.activityName}</h3>
                            <p class="text-sm">üìÖ ${act.activityDate} | üë§ ${act.responsible}</p>
                            <p class="text-sm text-gray-600 mt-1">${act.details}</p>
                        </div>
                    `).join("");
                } else {
                    container.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>";
                }
            } catch (err) {
                document.getElementById("activityList").innerHTML =
                    "<p class='text-red-500'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>";
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        loadActivities();
    </script>
</body>
</html>
